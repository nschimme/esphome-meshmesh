# Border Router Component

This component implements a border router for the `meshmesh` network, allowing it to communicate with standard IPv4 and IPv6 networks.

## Purpose

The `meshmesh` protocol is a custom L2 protocol that does not use IP for addressing. This makes it lightweight and efficient for communication between ESP nodes, but it also isolates the network from standard IP-based networks like WiFi and Ethernet.

This `border_router` component bridges this gap. It acts as a gateway, enabling nodes on the `meshmesh` network to communicate with devices on an Ethernet network, and vice-versa.

## Architecture

The border router is designed to run on a device with both a `meshmesh` radio and a standard network interface, like the `WT32-ETH01` (which has Ethernet).

It works by performing Network Address Translation (NAT):

1.  The border router has an IP address on the Ethernet network.
2.  When a `meshmesh` node sends a packet to a device on the Ethernet, the border router translates the packet from the `meshmesh` protocol to a standard TCP/IP packet. It uses its own IP address as the source for the outgoing packet.
3.  It maintains a state table to keep track of active connections.
4.  When a response is received from the Ethernet, the border router uses its state table to determine which `meshmesh` node the packet is for, translates it back to the `meshmesh` protocol, and forwards it to the correct node.

This architecture allows `meshmesh` nodes to access services on the IP network (like an MQTT broker or a web server) without needing a full IP stack themselves.

**Note:** The current C++ code provides the foundational scaffolding for this architecture, including the data structures and packet parsing logic. The core connection handling and data forwarding logic is not yet implemented.


## Mesh-to-Router Protocol

To enable full NAT functionality, a simple protocol is defined for communication between the mesh nodes and the border router. When a node wants to communicate with the IP network, it will construct a packet with the following format and send it to the border router's mesh address.

### Packet Format

| Field        | Size (bytes) | Description                                                                                             |
|--------------|--------------|---------------------------------------------------------------------------------------------------------|
| `command`    | 1            | The command to execute (e.g., connect, send data). See below.                                           |
| `session_id` | 2            | A unique ID for the connection, generated by the client node. Allows for multiple concurrent connections. |
| `payload`    | variable     | The data for the command. The format depends on the command.                                            |

### Commands

#### `0x01`: TCP Connect

This command requests the border router to open a new TCP connection.

**Payload Format:**
-   `ip_type` (1 byte): `0x04` for IPv4, `0x06` for IPv6.
-   `ip_address` (4 or 16 bytes): The destination IP address.
-   `port` (2 bytes, big-endian): The destination port.

#### `0x02`: TCP Data

This command sends data over an existing TCP connection.

**Payload Format:**
-   The raw data to be sent.

#### `0x03`: TCP Close

This command requests the border router to close an existing TCP connection.

**Payload Format:**
-   None.

#### `0x11`: UDP Send

This command sends a UDP packet.

**Payload Format:**
-   `ip_type` (1 byte): `0x04` for IPv4, `0x06` for IPv6.
-   `ip_address` (4 or 16 bytes): The destination IP address.
-   `port` (2 bytes, big-endian): The destination port.
-   The raw data to be sent.

---

*This protocol is a work in progress and may be subject to change.*

## Hardware

This component is designed with the **WT32-ETH01** board in mind, which provides both an ESP32 microcontroller and an Ethernet port. However, it could be adapted for other hardware with similar capabilities.

## Configuration

```yaml
# Example configuration for the border_router component
border_router:
  id: border_router_1
  meshmesh_id: meshmesh_component_id
  ethernet_id: ethernet_component_id

# You must also have the meshmesh and ethernet components configured
meshmesh:
  id: meshmesh_component_id
  # ... other meshmesh config

ethernet:
  id: ethernet_component_id
  type: LAN8720
  # ... other ethernet config
```

Configuration variables:

*   **id** (Required, ID): The ID of the `border_router` component.
*   **meshmesh_id** (Required, ID): The ID of the `meshmesh` component to bridge.
*   **ethernet_id** (Required, ID): The ID of the `ethernet` component to bridge.
